@namespace MauiLearningPlatform.Components.Course

<div class="prose max-w-none p-6">
<h1 id="dapper-inner-joins-deel-1" tabindex="-1"><a class="header-anchor" href="#dapper-inner-joins-deel-1" aria-hidden="true">#</a> Dapper inner joins deel 1</h1><h2 id="inleiding" tabindex="-1"><a class="header-anchor" href="#inleiding" aria-hidden="true">#</a> Inleiding</h2><p>In dit hoofdstuk leren we hoe we met Dapper een inner join kunnen uitvoeren en hierdoor data ophalen uit meerdere tabellen.</p><p><a href="https://gitpub.sebastiaanh.com/public/web/6e86d8a7-dda5-464b-a1ae-ad6eff886fa4" target="_blank" rel="noopener noreferrer">Download het voorbeeld van GitPub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="enkelvoudige-navigatie-properties" tabindex="-1"><a class="header-anchor" href="#enkelvoudige-navigatie-properties" aria-hidden="true">#</a> Enkelvoudige navigatie properties</h2><p>Bestudeer volgende klasse:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> KlantId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> Orderdatum <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Verzendadres <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> VerzendBedrijf <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Verzendland <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Verzendplaats <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Verzendpostcode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> WerknemerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Klant</span> Klant <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Werknemer</span> Werknemer <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br><div class="highlight-line"> </div><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In deze klasse zijn er 2 navigatie properties: <code>Klant</code> en <code>Werknemer</code>. Deze properties zijn enkelvoudig. Dit wil zeggen dat er slechts 1 klant en 1 werknemer aan een order gekoppeld kan worden. Zoals je kan zien komt elke navigation property overeen met een foreign key in de tabel <code>Orders</code>.</p><p>Indien we dus in view naast de rechtstreekse velden van de tabel <code>Orders</code> ook de naam van de klant en de werknemer willen tonen, kunnen we dit doen door de navigation properties te gebruiken. Data komt hierbij uit 2 tabellen. We moeten dus een inner join uitvoeren. In de OrderRepository ziet dit er als volgt uit:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> <span class="token function">OrdersOphalen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT O.*, K.*, W.*
                    FROM Orders O
                    INNER JOIN Klanten K ON O.KlantId = K.Id
                    INNER JOIN Werknemers W ON O.WerknemerID = W.Id&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> debugVar <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Order<span class="token punctuation">,</span> Klant<span class="token punctuation">,</span> Werknemer<span class="token punctuation">,</span> Order<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>order<span class="token punctuation">,</span> klant<span class="token punctuation">,</span> werknemer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Werknemer <span class="token operator">=</span> werknemer<span class="token punctuation">;</span>
                <span class="token keyword">return</span> order<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">splitOn</span><span class="token punctuation">:</span> <span class="token string">&quot;Id&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> debugVar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="opsplitsen-van-sql-rijen" tabindex="-1"><a class="header-anchor" href="#opsplitsen-van-sql-rijen" aria-hidden="true">#</a> Opsplitsen van SQL rijen</h2><p>Belangrijk hierbij op te merken is dat de navigatieproperties niet zelf worden opgevuld door Dapper. We moeten dit zelf doen in de lambda expressie. We geven aan Dapper mee dat de data van de klant en de werknemer moet worden opgevuld in de navigation properties van de order. Dit doen we door de navigation properties gelijk te stellen aan de data die we ophalen uit de database.</p><p>Dapper zal dus ruwe sql-data binnenkrijgen zoals ook wij dat te zien krijgen wanneer we de sql query uitvoeren. Hierdoor weet Dapper niet welke kolommen naar welke klassen moeten gemapt worden. Dit moeten we dus manueel oplossen. In ons geval is dit eenvoudig omdat de kolommen dezelfde naam hebben als de properties van de klasse. We kunnen dus de data rechtstreeks toekennen aan de properties. Indien dit niet het geval is, moeten we een mapping maken. Dit doen we door de kolomnamen te vermelden in de <code>splitOn</code> parameter. We geven hierbij de kolomnamen mee die de verschillende objecten van elkaar scheiden. In ons geval is dit de Id kolom.</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> <span class="token function">OrdersOphalen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT O.*, K.*, W.*
                    FROM Orders O
                    INNER JOIN Klanten K ON O.KlantId = K.Id
                    INNER JOIN Werknemers W ON O.WerknemerID = W.Id&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> debugVar <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Order<span class="token punctuation">,</span> Klant<span class="token punctuation">,</span> Werknemer<span class="token punctuation">,</span> Order<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>order<span class="token punctuation">,</span> klant<span class="token punctuation">,</span> werknemer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Werknemer <span class="token operator">=</span> werknemer<span class="token punctuation">;</span>
                <span class="token keyword">return</span> order<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">splitOn</span><span class="token punctuation">:</span> <span class="token string">&quot;Id&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> debugVar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="mappen-van-sql-rijen" tabindex="-1"><a class="header-anchor" href="#mappen-van-sql-rijen" aria-hidden="true">#</a> Mappen van SQL rijen</h2><p>In de C# query die we schrijven gebruiken we meerdere types. Het laatste type moet steeds het return type zijn van onze methode maar ook van de mapping functie. Merk op dat dit in ons voorbeeld het type &#39;Order&#39; is. De argmunenten van de mapping functie zijn objecten die overeenkomen met de eerste <em>n-1</em> parameters van de Query functie. Het resultaat van de mapping functie moet een object zijn van het laatste type. In ons voorbeeld is dit dus een Order object. Hierna zullen de navigatieproperties van dit object opgevuld zijn.</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> <span class="token function">OrdersOphalen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT O.*, K.*, W.*
                    FROM Orders O
                    INNER JOIN Klanten K ON O.KlantId = K.Id
                    INNER JOIN Werknemers W ON O.WerknemerID = W.Id&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> debugVar <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Order<span class="token punctuation">,</span> Klant<span class="token punctuation">,</span> Werknemer<span class="token punctuation">,</span> Order<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>order<span class="token punctuation">,</span> klant<span class="token punctuation">,</span> werknemer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Werknemer <span class="token operator">=</span> werknemer<span class="token punctuation">;</span>
                <span class="token keyword">return</span> order<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token named-parameter punctuation">splitOn</span><span class="token punctuation">:</span> <span class="token string">&quot;Id&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> debugVar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><div class="highlight-line"> </div><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="joins-met-parameters" tabindex="-1"><a class="header-anchor" href="#joins-met-parameters" aria-hidden="true">#</a> Joins met parameters</h2><p>Indien we in onze join ook nog parameters willen gebruiken, moeten we deze meegeven aan de Query functie. We kunnen dit doen door een anoniem object te maken met de gewenste parameters. Deze parameters kunnen we dan gebruiken in de sql query. In ons voorbeeld willen we enkel de orders ophalen van een bepaalde klant. We voegen dus een parameter toe aan de Query functie en gebruiken deze in de sql query.</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> <span class="token function">OrdersOphalenVoorKlant</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> bedrijfsnaam<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT O.*, K.*, W.*
                    FROM Orders O
                    INNER JOIN Klanten K ON O.KlantId = K.Id
                    INNER JOIN Werknemers W ON O.WerknemerId = W.Id
                    WHERE K.Bedrijf LIKE &#39;%&#39; + &#64;bedrijfsnaam + &#39;%&#39;&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Order<span class="token punctuation">,</span> Klant<span class="token punctuation">,</span> Werknemer<span class="token punctuation">,</span> Order<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>order<span class="token punctuation">,</span> klant<span class="token punctuation">,</span> werknemer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Werknemer <span class="token operator">=</span> werknemer<span class="token punctuation">;</span>
                <span class="token keyword">return</span> order<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token punctuation">{</span> bedrijfsnaam <span class="token operator">=</span> bedrijfsnaam <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>
</div>
