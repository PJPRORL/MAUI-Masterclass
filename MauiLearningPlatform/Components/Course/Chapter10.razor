@namespace MauiLearningPlatform.Components.Course

<div class="prose max-w-none p-6">
<h1 id="dapper-inner-joins-deel-2" tabindex="-1"><a class="header-anchor" href="#dapper-inner-joins-deel-2" aria-hidden="true">#</a> Dapper inner joins deel 2</h1><h2 id="inleiding" tabindex="-1"><a class="header-anchor" href="#inleiding" aria-hidden="true">#</a> Inleiding</h2><p>In dit hoofdstuk leren we hoe we met Dapper een inner join kunnen uitvoeren en hierdoor data ophalen uit meerdere tabellen. Specifiek behandelen we een-op-veel relaties.</p><p><a href="https://gitpub.sebastiaanh.com/public/web/46ef35c2-1dda-40ee-bc8b-d05537965b9c" target="_blank" rel="noopener noreferrer">Download het voorbeeld van GitPub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="meervoudige-navigatie-properties" tabindex="-1"><a class="header-anchor" href="#meervoudige-navigatie-properties" aria-hidden="true">#</a> Meervoudige navigatie properties</h2><p>Bestudeer volgende klasse:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Klant</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Adres <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Bedrijf <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Land <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Plaats <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Postcode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Telefoonnummer <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> Orders <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Bedrijf<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In deze klasse is er 1 meervoudige navigatie property: <code>Orders</code>. Deze property is meervoudig. Dit wil zeggen dat er meerdere orders aan een klant gekoppeld kunnen worden. Zoals je kan zien komt de navigation property overeen met een foreign key in de tabel <code>Orders</code>.</p><p>Om alle klante op te halen inclusief hun klanten, kunnen we volgende SQL query uitvoeren:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> K<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> O<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> Klanten K <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orders O <span class="token keyword">ON</span> K<span class="token punctuation">.</span>Id <span class="token operator">=</span> O<span class="token punctuation">.</span>KlantId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> K<span class="token punctuation">.</span>Bedrijf<span class="token punctuation">,</span> O<span class="token punctuation">.</span>Id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Voer deze query uit in Azure Data Studio en bekijk het resultaat. Je zal merken dat we heel wat gedupliceerde data krijgen. We krijgen namelijk meerdere keren dezelfde klant. Om dit op te lossen, zullen we moeten groeperen op het klant-object.</p><h2 id="groeperen-van-data" tabindex="-1"><a class="header-anchor" href="#groeperen-van-data" aria-hidden="true">#</a> Groeperen van data</h2><p>Als we deze logica zouden vertalen naar C# code, zal dit er als volgt uit zien in de KlantRepository:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> <span class="token function">KlantenOphalenMetOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT K.*, O.*
                    FROM Klanten K
                    INNER JOIN Orders O ON K.Id = O.KlantId
                    ORDER BY K.Bedrijf, O.Id&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> klanten <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Klant<span class="token punctuation">,</span> Order<span class="token punctuation">,</span> Klant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
        sql<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>klant<span class="token punctuation">,</span> order<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
            klant<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> order <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> klant<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">GroepeerKlanten</span><span class="token punctuation">(</span>klanten<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> <span class="token function">GroepeerKlanten</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> klanten<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> gegroepeerd <span class="token operator">=</span> klanten<span class="token punctuation">.</span><span class="token function">GroupBy</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> klantenMetOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> groep <span class="token keyword">in</span> gegroepeerd<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> klant <span class="token operator">=</span> groep<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> alleOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> k <span class="token keyword">in</span> groep<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            alleOrders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        klant<span class="token punctuation">.</span>Orders <span class="token operator">=</span> alleOrders<span class="token punctuation">;</span>
        klantenMetOrders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>klant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> klantenMetOrders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Merk op dat we hier op regel 14 de orders gelijk stellen aan een nieuwe lijst van orders. Dit is nodig omdat Dapper de orders niet automatisch zal toevoegen aan de klant. We zullen dit zelf moeten doen. Voorlopig is de <code>Orders</code> property dus gelijk aan een lijst met 1 order.</p><p>De methode <code>GroepeerKlanten</code> zal de klanten groeperen op basis van hun Id. Hierdoor krijgen we een lijst met klanten waarbij elke klant maar 1 keer voorkomt. De orders van de klant worden hierbij samengevoegd in een lijst. Deze lijst wordt dan toegekend aan de <code>Orders</code> property van de klant.</p><p>Als eindresultaat krijgen we dus een lijst met klanten waarbij elke klant maar 1 keer voorkomt en waarbij de orders van de klant in een lijst zitten.</p><h2 id="meervoudige-relaties-over-meerdere-tabellen" tabindex="-1"><a class="header-anchor" href="#meervoudige-relaties-over-meerdere-tabellen" aria-hidden="true">#</a> Meervoudige relaties over meerdere tabellen</h2><p>Stel dat we alle klanten willen tonen inclusief hun orders. Daarnaast willen we voor elk order ook nog de orderlijnen tonen die hierbij horen. We zullen dus een inner join moeten uitvoeren op 3 tabellen. Dit kunnen we doen door de volgende query uit te voeren:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> K<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> O<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> OL<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> Klanten K <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orders O <span class="token keyword">ON</span> K<span class="token punctuation">.</span>Id <span class="token operator">=</span> O<span class="token punctuation">.</span>KlantId <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orderlijnen OL <span class="token keyword">ON</span> O<span class="token punctuation">.</span>Id <span class="token operator">=</span> OL<span class="token punctuation">.</span>OrderId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> K<span class="token punctuation">.</span>Bedrijf<span class="token punctuation">,</span> O<span class="token punctuation">.</span>Id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Voer deze query uit in Azure Data Studio en bekijk het resultaat. Je zal merken dat we heel wat gedupliceerde data krijgen. We krijgen namelijk meerdere keren dezelfde klant en order. Om dit op te lossen, zullen we moeten groeperen op het klant-object en op het order-object.</p><p>In C# code zal dit er als volgt uit zien in de Klantrepository:</p><div class="vp-code-tabs"><div class="vp-code-tabs-nav" role="tablist"><button type="button" class="vp-code-tab-nav active" role="tab" aria-controls="codetab-58-0" aria-selected="true">KlantenOphalenMetOrdersEnOrderlijnen</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-58-1" aria-selected="false">GroepeerKlanten</button><button type="button" class="vp-code-tab-nav" role="tab" aria-controls="codetab-58-2" aria-selected="false">GroepeerOrders</button></div><!--[--><div class="vp-code-tab active" id="codetab-58-0" role="tabpanel" aria-expanded="true"><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> <span class="token function">KlantenOphalenMetOrdersEnOrderlijnen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT K.*, O.*, OL.*
                    FROM Klanten K
                    INNER JOIN Orders O ON K.Id = O.KlantId
                    INNER JOIN Orderlijnen OL ON O.Id = OL.OrderId
                    ORDER BY K.Bedrijf, O.Id&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> klanten <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Klant<span class="token punctuation">,</span> Order<span class="token punctuation">,</span> Orderlijn<span class="token punctuation">,</span> Klant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>klant<span class="token punctuation">,</span> order<span class="token punctuation">,</span> orderlijn<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                orderlijn<span class="token punctuation">.</span>Order <span class="token operator">=</span> order<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Orderlijnen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Orderlijn<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> orderlijn <span class="token punctuation">}</span><span class="token punctuation">;</span>
                klant<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> order <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> klant<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> gegroepeerdeKlanten <span class="token operator">=</span> <span class="token function">GroepeerKlanten</span><span class="token punctuation">(</span>klanten<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> gegroepeerdeKlanten<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            k<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token function">GroepeerOrders</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>Orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="vp-code-tab" id="codetab-58-1" role="tabpanel" aria-expanded="false"><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> <span class="token function">GroepeerKlanten</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> klanten<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> gegroepeerd <span class="token operator">=</span> klanten<span class="token punctuation">.</span><span class="token function">GroupBy</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">List<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> klantenMetOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> groep <span class="token keyword">in</span> gegroepeerd<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> klant <span class="token operator">=</span> groep<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> alleOrders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> k <span class="token keyword">in</span> groep<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            alleOrders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        klant<span class="token punctuation">.</span>Orders <span class="token operator">=</span> alleOrders<span class="token punctuation">;</span>
        klantenMetOrders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>klant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> klantenMetOrders<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="vp-code-tab" id="codetab-58-2" role="tabpanel" aria-expanded="false"><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">ICollection<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> <span class="token function">GroepeerOrders</span><span class="token punctuation">(</span><span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span> orders<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> orders<span class="token punctuation">.</span><span class="token function">GroupBy</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>g <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        order<span class="token punctuation">.</span>Orderlijnen <span class="token operator">=</span> g<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Orderlijnen<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--]--></div><p>In bovenstaande code groeperen we eerst op regel 17 de klanten. Daarna groeperen we op regel 23 de orders.</p><p>Het groeperen van de orders gebeurt op dezelfde denkwijze en manier als het groeperen van de klanten.</p><h3 id="combinatie-van-meervoudige-en-enkelvoudige-relaties-1" tabindex="-1"><a class="header-anchor" href="#combinatie-van-meervoudige-en-enkelvoudige-relaties-1" aria-hidden="true">#</a> Combinatie van meervoudige en enkelvoudige relaties - 1</h3><p>Stel dat we in ons overzicht alle klanten willen tonen inclusief hun orders. Daarnaast willen we voor elk order ook nog de orderlijnen tonen die hierbij horen. Voor een orderlijn willen we ook nog de naam tonen van het product dat gekoppeld is. De SQL om al deze data op te halen ziet er als volgt uit:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> K<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> O<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> OL<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> P<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> Klanten K <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orders O <span class="token keyword">ON</span> K<span class="token punctuation">.</span>Id <span class="token operator">=</span> O<span class="token punctuation">.</span>KlantId <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orderlijnen OL <span class="token keyword">ON</span> O<span class="token punctuation">.</span>Id <span class="token operator">=</span> OL<span class="token punctuation">.</span>OrderId <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Producten P <span class="token keyword">ON</span> OL<span class="token punctuation">.</span>ProductId <span class="token operator">=</span> P<span class="token punctuation">.</span>Id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> K<span class="token punctuation">.</span>Bedrijf<span class="token punctuation">,</span> O<span class="token punctuation">.</span>Id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>De denkwijze om dit op te lossen is een combinatie van de vorige voorbeelden. De code ziet er als volgt uit:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> <span class="token function">KlantenOphalenMetOrdersEnOrderlijnenEnProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT K.*, O.*, OL.*, P.*
                    FROM Klanten K
                    INNER JOIN Orders O ON K.Id = O.KlantId
                    INNER JOIN Orderlijnen OL ON O.Id = OL.OrderId
                    INNER JOIN Producten P ON OL.ProductId = P.Id
                    ORDER BY K.Bedrijf, O.Id&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> klanten <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Klant<span class="token punctuation">,</span> Order<span class="token punctuation">,</span> Orderlijn<span class="token punctuation">,</span> Product<span class="token punctuation">,</span> Klant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>klant<span class="token punctuation">,</span> order<span class="token punctuation">,</span> orderlijn<span class="token punctuation">,</span> product<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                orderlijn<span class="token punctuation">.</span>Order <span class="token operator">=</span> order<span class="token punctuation">;</span>
                orderlijn<span class="token punctuation">.</span>Product <span class="token operator">=</span> product<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Orderlijnen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Orderlijn<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> orderlijn <span class="token punctuation">}</span><span class="token punctuation">;</span>
                klant<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> order <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> klant<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> gegroepeerdeKlanten <span class="token operator">=</span> <span class="token function">GroepeerKlanten</span><span class="token punctuation">(</span>klanten<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> gegroepeerdeKlanten<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            k<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token function">GroepeerOrders</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>Orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Product is enkelvoudig en kan dus rechtstreeks worden toegekend</li><li>Orderlijnen is meervoudig en kan dus niet rechtstreeks worden toegekend. We moeten eerst groeperen op de orderlijnen van een order.</li><li>Orders is meervoudig en kan dus niet rechtstreeks worden toegekend. We moeten eerst groeperen op de orders van een klant.</li></ul><h3 id="combinatie-van-meervoudige-en-enkelvoudige-relaties-2" tabindex="-1"><a class="header-anchor" href="#combinatie-van-meervoudige-en-enkelvoudige-relaties-2" aria-hidden="true">#</a> Combinatie van meervoudige en enkelvoudige relaties - 2</h3><p>Stel dat we in ons overzicht alle klanten willen tonen met bijhorende orders. Voor elk order willen we de orderlijnen tonen inclusief het product dat hieraan gekoppeld is. Daarnaast willen we ook weten welke werknemer dit order heeft verwerkt. De SQL om al deze data op te halen ziet er als volgt uit:</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> K<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> O<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> OL<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> P<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> W<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span> Klanten K
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orders O <span class="token keyword">ON</span> K<span class="token punctuation">.</span>Id <span class="token operator">=</span> O<span class="token punctuation">.</span>KlantId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Orderlijnen OL <span class="token keyword">ON</span> O<span class="token punctuation">.</span>Id <span class="token operator">=</span> OL<span class="token punctuation">.</span>OrderId
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Producten P <span class="token keyword">ON</span> OL<span class="token punctuation">.</span>ProductId <span class="token operator">=</span> P<span class="token punctuation">.</span>Id
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> Werknemers W <span class="token keyword">ON</span> O<span class="token punctuation">.</span>WerknemerId <span class="token operator">=</span> W<span class="token punctuation">.</span>Id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> K<span class="token punctuation">.</span>Bedrijf<span class="token punctuation">,</span> O<span class="token punctuation">.</span>Id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>De denkwijze om dit op te lossen is een combinatie van de vorige voorbeelden. De code ziet er als volgt uit:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Klant<span class="token punctuation">&gt;</span></span> <span class="token function">KlantenOphalenMetOrdersEnOrderlijnenEnProductEnWerknemers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;SELECT K.*, O.*, OL.*, P.*, W.*
                    FROM Klanten K
                    INNER JOIN Orders O ON K.Id = O.KlantId
                    INNER JOIN Orderlijnen OL ON O.Id = OL.OrderId
                    INNER JOIN Producten P ON OL.ProductId = P.Id
                    INNER JOIN Werknemers W ON O.WerknemerId = W.Id
                    ORDER BY K.Bedrijf, O.Id&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> klanten <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Query</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Klant<span class="token punctuation">,</span> Order<span class="token punctuation">,</span> Orderlijn<span class="token punctuation">,</span> Product<span class="token punctuation">,</span> Werknemer<span class="token punctuation">,</span> Klant<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            sql<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>klant<span class="token punctuation">,</span> order<span class="token punctuation">,</span> orderlijn<span class="token punctuation">,</span> product<span class="token punctuation">,</span> werknemer<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                order<span class="token punctuation">.</span>Klant <span class="token operator">=</span> klant<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Werknemer <span class="token operator">=</span> werknemer<span class="token punctuation">;</span>
                orderlijn<span class="token punctuation">.</span>Order <span class="token operator">=</span> order<span class="token punctuation">;</span>
                orderlijn<span class="token punctuation">.</span>Product <span class="token operator">=</span> product<span class="token punctuation">;</span>
                order<span class="token punctuation">.</span>Orderlijnen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Orderlijn<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> orderlijn <span class="token punctuation">}</span><span class="token punctuation">;</span>
                klant<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> order <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> klant<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> gegroepeerdeKlanten <span class="token operator">=</span> <span class="token function">GroepeerKlanten</span><span class="token punctuation">(</span>klanten<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> gegroepeerdeKlanten<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>k <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            k<span class="token punctuation">.</span>Orders <span class="token operator">=</span> <span class="token function">GroepeerOrders</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>Orders<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> k<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>Werknemer is enkelvoudig en kan dus rechtstreeks worden toegekend</li><li>Product is enkelvoudig en kan dus rechtstreeks worden toegekend</li><li>Orderlijnen is meervoudig en kan dus niet rechtstreeks worden toegekend. We moeten eerst groeperen op de orderlijnen van een order.</li><li>Orders is meervoudig en kan dus niet rechtstreeks worden toegekend. We moeten eerst groeperen op de orders van een klant.</li></ul><h2 id="enkele-belangrijke-aandachtspunten" tabindex="-1"><a class="header-anchor" href="#enkele-belangrijke-aandachtspunten" aria-hidden="true">#</a> Enkele belangrijke aandachtspunten</h2><ul><li>Hoe meer meervoudige navigatie properties je hebt, hoe meer je zal moeten groeperen en hoe langer de query zal worden. Dit betekent ook een langere uitvoeringstijd van de query.</li><li>Voeg enkel hetgeen toe dat je nodig hebt.</li><li>Denk aan performantie.</li></ul>
</div>
