@namespace MauiLearningPlatform.Components.Course

<div class="prose max-w-none p-6">
<h1 id="dapper-insert-update-en-delete" tabindex="-1"><a class="header-anchor" href="#dapper-insert-update-en-delete" aria-hidden="true">#</a> Dapper insert, update en delete</h1><h2 id="inleiding" tabindex="-1"><a class="header-anchor" href="#inleiding" aria-hidden="true">#</a> Inleiding</h2><p>In dit hoofdstuk gaan we kijken naar het toevoegen, wijzigen en verwijderen van data in de database.</p><p>Om er voor te zorgen dat dit zo vlot mogelijk verloopt, is het aangewezen om goed geconfigureerde primary keys te gebruiken. Dit zorgt er voor dat Dapper de juiste records kan terugvinden en aanpassen.</p><p>Je kan het voorbeeld <a href="https://gitpub.sebastiaanh.com/public/web/89036b01-6a3f-4c59-a6ff-66b12b028126" target="_blank" rel="noopener noreferrer">hier downloaden<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="verschil-tussen-selecteren-en-wijzigen-van-data" tabindex="-1"><a class="header-anchor" href="#verschil-tussen-selecteren-en-wijzigen-van-data" aria-hidden="true">#</a> Verschil tussen selecteren en wijzigen van data</h2><p>Bij een select statement maken we gebruiken van <code>db.Query&lt;T&gt;()</code> of <code>db.QueryFirstOrDefault&lt;T&gt;()</code>. Bij het wijzigen van data maken we gebruik van <code>db.Execute()</code>. Deze laatste methode heeft als returnwaarde het aantal geimpacteerde rijen. Bij een insert statement is dit 1, bij een update statement is dit het aantal gewijzigde rijen en bij een delete statement is dit het aantal verwijderde rijen.</p><h2 id="toevoegen-van-data" tabindex="-1"><a class="header-anchor" href="#toevoegen-van-data" aria-hidden="true">#</a> Toevoegen van data</h2><p>Om data toe te voegen aan de database, hebben we insert logica nodig in onze repository. In het geval van een order toevoegen, ziet dit er als volgt uit:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">ToevoegenOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;INSERT INTO Orders (klantId, werknemerId, orderdatum, verzendadres, verzendplaats, verzendpostcode, verzendland)
        VALUES (&#64;klantId, &#64;werknemerId, &#64;orderdatum, &#64;verzendadres, &#64;verzendplaats, &#64;verzendpostcode, &#64;verzendland)&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        klantId <span class="token operator">=</span> order<span class="token punctuation">.</span>Klant<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        werknemerId <span class="token operator">=</span> order<span class="token punctuation">.</span>Werknemer<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        orderdatum <span class="token operator">=</span> order<span class="token punctuation">.</span>Orderdatum<span class="token punctuation">,</span>
        verzendadres <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendadres<span class="token punctuation">,</span>
        verzendplaats <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendplaats<span class="token punctuation">,</span>
        verzendpostcode <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendpostcode<span class="token punctuation">,</span>
        verzendland <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendland
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> affectedRows <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> affectedRows <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><div class="highlight-line"> </div><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Bekijk bovenstaande code. Het SQL statement zal zorgen voor de insert. Hierbij dienen we de parameters te voorzien. Om de query uit te voeren, maken we gebruik van de <code>Execute()</code> methode. Deze methode heeft als returnwaarde het aantal geimpacteerde rijen. In het geval van een insert statement is dit 1. We kunnen dus controleren of de insert gelukt is door te kijken of de returnwaarde gelijk is aan 1.</p><p>In onze view voorzien we dus alle nodige velden om een nieuw order aan te maken. In het geval van onze foreign keys (klant en werknemer) maken we gebruik van een dropdownlist. Deze dropdown moet dus op voorhand worden opgevuld door een lijst van klanten en werknemers. Bestudeerd hiervoor het viewmodel in het voorbeeld.</p><h2 id="wijzigen-van-data" tabindex="-1"><a class="header-anchor" href="#wijzigen-van-data" aria-hidden="true">#</a> Wijzigen van data</h2><p>Om data te wijzigen maken we gebruik van hetzelfde formulier als bij het toevoegen van data. Dit formulier wordt ingevuld wanneer een order geselecteerd wordt in de lijst van orders. We maken hiervoor gebruik van de property <code>SelectedOrder</code> in het viewmodel. Deze property wordt ingevuld wanneer een order geselecteerd wordt in de lijst van orders.</p><p>Bij het opslaan van de data maken we gebruik van update logica in onze repository. In het geval van een order wijzigen, ziet dit er als volgt uit:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">WijzigenOrder</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;UPDATE Orders
                    SET klantId = &#64;klantId,
                        werknemerId = &#64;werknemerId,
                        orderdatum = &#64;orderdatum,
                        verzendadres = &#64;verzendadres,
                        verzendplaats = &#64;verzendplaats,
                        verzendpostcode = &#64;verzendpostcode,
                        verzendland = &#64;verzendland
                    WHERE Id = &#64;id&quot;</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span>
    <span class="token punctuation">{</span>
        id <span class="token operator">=</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        klantId <span class="token operator">=</span> order<span class="token punctuation">.</span>Klant<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        werknemerId <span class="token operator">=</span> order<span class="token punctuation">.</span>Werknemer<span class="token punctuation">.</span>Id<span class="token punctuation">,</span>
        orderdatum <span class="token operator">=</span> order<span class="token punctuation">.</span>Orderdatum<span class="token punctuation">,</span>
        verzendadres <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendadres<span class="token punctuation">,</span>
        verzendplaats <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendplaats<span class="token punctuation">,</span>
        verzendpostcode <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendpostcode<span class="token punctuation">,</span>
        verzendland <span class="token operator">=</span> order<span class="token punctuation">.</span>Verzendland
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> affectedRows <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> affectedRows <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Ook hier maken wegebruik van de <code>Execute()</code> methode. Deze methode heeft als returnwaarde het aantal geimpacteerde rijen. In het geval van een update statement is dit het aantal gewijzigde rijen. We kunnen dus controleren of de update gelukt is door te kijken of de returnwaarde gelijk is aan 1.</p><h2 id="verwijderen-van-data" tabindex="-1"><a class="header-anchor" href="#verwijderen-van-data" aria-hidden="true">#</a> Verwijderen van data</h2><p>Om data te verwijderen hebben we geen formulier nodig. De gebruiker moet in de lijst van orders een order selecteren en daarna op de knop &quot;Verwijderen&quot; klikken. Bij het verwijderen van een order maken we gebruik van delete logica in onze repository. In het geval van een order verwijderen, ziet dit er als volgt uit:</p><div class="language-csharp line-numbers-mode" data-ext="cs"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">VerwijderenOrder</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">string</span></span> sql <span class="token operator">=</span> <span class="token string">&#64;&quot;DELETE FROM Orderlijnen WHERE OrderId = &#64;id;
    DELETE FROM Orders WHERE Id = &#64;id&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">using</span> <span class="token class-name">IDbConnection</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlConnection</span><span class="token punctuation">(</span>ConnectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> affectedRows <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> id <span class="token operator">=</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> affectedRows <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Merk hier op dat we eerst de orderlijnen verwijderen en daarna pas de order zelf. Dit is nodig omdat we een foreign key constraint hebben op de orderlijnen. Als we eerst de order zouden verwijderen, dan zou dit een foutmelding geven omdat er nog orderlijnen bestaan voor deze order.</p>
</div>
