@using MauiLearningPlatform.Services
@inject ProjectState ProjectState
@inject IJSRuntime JSRuntime

<div class="file-explorer">
    <div class="explorer-header">
        <span>üìÅ Project</span>
        <div class="header-actions">
            <button class="action-btn" @onclick="ExportProject" title="Export Project">‚¨áÔ∏è</button>
            <button class="action-btn" @onclick="TriggerImport" title="Import Project">‚¨ÜÔ∏è</button>
            <button class="add-btn" @onclick="ShowAddModal" title="Add New File">+</button>
        </div>
    </div>
    <div class="explorer-content">
        @foreach (var group in ProjectState.Files.GroupBy(f => f.Folder).OrderBy(g => g.Key))
        {
            <div class="folder">
                <div class="folder-name">@(string.IsNullOrEmpty(group.Key) ? "Root" : group.Key)</div>
                @foreach (var file in group)
                {
                    <div class="file-item @(ProjectState.ActiveFile == file ? "active" : "")" 
                         @onclick="() => SelectFile(file)">
                        <span class="file-icon">@(file.Type == "csharp" ? "üìÑ" : "üé®")</span>
                        <span class="file-name">@file.Name</span>
                        <span class="delete-btn" @onclick="() => ShowDeleteModal(file)" @onclick:stopPropagation="true">üóëÔ∏è</span>
                    </div>
                }
            </div>
        }
    </div>
</div>

<InputFile id="importInput" OnChange="HandleFileSelected" hidden />

@if (ShowAddDialog)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3>Add New File</h3>
            <div class="form-group">
                <label>Folder:</label>
                <select @bind="NewFileFolder">
                    <option value="">(Root)</option>
                    <option value="Views">Views</option>
                    <option value="ViewModels">ViewModels</option>
                    <option value="Services">Services</option>
                    <option value="Models">Models</option>
                </select>
            </div>
            <div class="form-group">
                <label>File Name:</label>
                <input @bind="NewFileName" placeholder="e.g. MyPage.xaml or MyClass.cs" />
            </div>
            <div class="modal-actions">
                <button @onclick="CancelAdd">Cancel</button>
                <button class="primary" @onclick="ConfirmAdd">Create</button>
            </div>
        </div>
    </div>
}

@if (ShowDeleteDialog)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3>Delete File?</h3>
            <p>Are you sure you want to delete <strong>@FileToDelete?.Name</strong>?</p>
            <div class="modal-actions">
                <button @onclick="CancelDelete">Cancel</button>
                <button class="danger" @onclick="ConfirmDelete">Delete</button>
            </div>
        </div>
    </div>
}

<style>
    .file-explorer {
        background: #252526;
        color: #cccccc;
        height: 100%;
        display: flex;
        flex-direction: column;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
    }
    .explorer-header {
        padding: 10px;
        font-weight: bold;
        background: #333333;
        border-bottom: 1px solid #3e3e42;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .header-actions {
        display: flex;
        gap: 5px;
    }
    .add-btn, .action-btn {
        background: #3e3e42;
        color: white;
        border: none;
        border-radius: 3px;
        width: 24px;
        height: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .add-btn:hover, .action-btn:hover { background: #505050; }
    
    .explorer-content {
        flex: 1;
        overflow-y: auto;
        padding: 5px;
    }
    .folder-name {
        font-weight: bold;
        padding: 5px;
        color: #a0a0a0;
        text-transform: uppercase;
        font-size: 12px;
    }
    .file-item {
        padding: 5px 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .file-item:hover {
        background: #2a2d2e;
    }
    .file-item.active {
        background: #37373d;
        color: white;
    }
    .file-icon {
        margin-right: 8px;
    }
    .file-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .delete-btn {
        opacity: 0;
        font-size: 12px;
        padding: 2px;
        cursor: pointer;
    }
    .file-item:hover .delete-btn {
        opacity: 1;
    }
    .delete-btn:hover {
        background: #4d4d4d;
        border-radius: 3px;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000;
    }
    .modal-content {
        background: #2d2d30;
        padding: 20px;
        border-radius: 5px;
        width: 300px;
        border: 1px solid #3e3e42;
        color: white;
    }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-group input, .form-group select {
        width: 100%; padding: 5px; background: #1e1e1e; border: 1px solid #3e3e42; color: white;
    }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .modal-actions button {
        padding: 5px 15px; border: none; border-radius: 3px; cursor: pointer;
    }
    .modal-actions button.primary { background: #007acc; color: white; }
    .modal-actions button.danger { background: #f44336; color: white; }
</style>

@code {
    private bool ShowAddDialog = false;
    private bool ShowDeleteDialog = false;
    private string NewFileName = "";
    private string NewFileFolder = "ViewModels";
    private VirtualFile FileToDelete;

    protected override void OnInitialized()
    {
        ProjectState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ProjectState.OnChange -= StateHasChanged;
    }

    private void SelectFile(VirtualFile file)
    {
        ProjectState.SetActiveFile(file);
    }

    private async Task ExportProject()
    {
        var json = ProjectState.ExportProject();
        var fileName = $"maui-project-{DateTime.Now:yyyyMMdd-HHmm}.json";
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, json);
    }

    private async Task TriggerImport()
    {
        await JSRuntime.InvokeVoidAsync("triggerClick", "importInput");
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            ProjectState.ImportProject(json);
        }
    }

    private void ShowAddModal()
    {
        ShowAddDialog = true;
        NewFileName = "";
    }

    private void CancelAdd() => ShowAddDialog = false;

    private void ConfirmAdd()
    {
        if (string.IsNullOrWhiteSpace(NewFileName)) return;

        // Auto-append extension if missing based on folder
        if (!NewFileName.Contains("."))
        {
            if (NewFileFolder == "Views") NewFileName += ".xaml";
            else NewFileName += ".cs";
        }

        var fullPath = string.IsNullOrEmpty(NewFileFolder) ? NewFileName : $"{NewFileFolder}/{NewFileName}";
        
        string type = "csharp";
        string content = "";

        if (NewFileName.EndsWith(".xaml"))
        {
            type = "xml";
            var className = NewFileName.Replace(".xaml", "");
            var sb = new System.Text.StringBuilder();
            sb.AppendLine("<ContentPage xmlns=\"http://schemas.microsoft.com/dotnet/2021/maui\"");
            sb.AppendLine("             xmlns:x=\"http://schemas.microsoft.com/winfx/2009/xaml\"");
            sb.AppendLine($"             x:Class=\"MauiLearningPlatform.{className}\">");
            sb.AppendLine("    <VerticalStackLayout>");
            sb.AppendLine("        <Label Text=\"New Page\" />");
            sb.AppendLine("    </VerticalStackLayout>");
            sb.AppendLine("</ContentPage>");
            content = sb.ToString();
        }
        else 
        {
            type = "csharp";
            var className = NewFileName.Replace(".cs", "");
            var sb = new System.Text.StringBuilder();
            sb.AppendLine("namespace MauiLearningPlatform;");
            sb.AppendLine("");
            sb.AppendLine($"public class {className}");
            sb.AppendLine("{");
            sb.AppendLine("");
            sb.AppendLine("}");
            content = sb.ToString();
        }

        ProjectState.AddFile(fullPath, content, type);
        
        // Automatically switch to the new file
        var newFile = ProjectState.Files.FirstOrDefault(f => f.Path == fullPath);
        if (newFile != null) ProjectState.SetActiveFile(newFile);

        ShowAddDialog = false;
    }

    private void ShowDeleteModal(VirtualFile file)
    {
        FileToDelete = file;
        ShowDeleteDialog = true;
    }

    private void CancelDelete() => ShowDeleteDialog = false;

    private void ConfirmDelete()
    {
        if (FileToDelete != null)
        {
            ProjectState.DeleteFile(FileToDelete);
        }
        ShowDeleteDialog = false;
    }
}
